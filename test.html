<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulairdsde HubSpot â€“ Auto-remplissage lien_residence</title>

  <!-- Load HubSpot Forms v2 library -->
<script charset="utf-8" type="text/javascript" src="https://js.hsforms.net/forms/embed/v2.js"></script>
</head>

<body>
  <h1>Contact</h1>
  <p>Le champ <code>lien_residence</code> sera automatiquement rempli avec lâ€™URL actuelle de cette page.</p>

  <!-- Container for the form -->
  <div id="hubspot-form"></div>

  <script>
    // Immediately log current URL for debugging
    const pageUrl = window.location.href;
    console.log("ðŸŒ Current page URL:", pageUrl);

    // Wait until HubSpot library is loaded
    window.addEventListener("load", function () {
      if (typeof hbspt === "undefined" || !hbspt.forms) {
        console.error("âŒ HubSpot library did not load. Check network or CORS issues.");
        return;
      }

      hbspt.forms.create({
        region: "na1",
        portalId: "45176032", // your real portal ID
        formId: "4a868650-22f3-4bb5-a389-259d208f3973", // your real form ID
        target: "#hubspot-form",

        onFormReady: function ($form) {
          console.log("âœ… HubSpot form ready, attempting to fill lien_residence...");

          // Function to find and fill lien_residence field
          function fillLienResidence() {
            // Works with both modern HS naming like 0-1/lien_residence and plain lien_residence
            const input = $form.find('input[name*="0-1/lien_residence"]');
            if (!input.length) {
              console.warn("âš ï¸ Field 'lien_residence' not found yet.");
              return false;
            }

            if (input.val() === "") {
              input.val(pageUrl).change();
              console.log("âœï¸ Field 'lien_residence' filled with:", pageUrl);
            } else {
              console.log("âœ… Field 'lien_residence' already contains:", input.val());
            }
            return true;
          }

          // Retry up to 10 times in case the field renders slowly
          let attempts = 0;
          const interval = setInterval(() => {
            attempts++;
            console.log(`ðŸ”„ Attempt ${attempts} to fill field...`);
            if (fillLienResidence() || attempts >= 10) {
              clearInterval(interval);
              console.log("ðŸŸ¢ Done checking after", attempts, "attempt(s).");
            }
          }, 500);

          // Ensure latest value before submit
          $form.on("submit", function () {
            fillLienResidence();
          });
        }
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulaire HubSpot – Auto Remplissage Vérifié</title>

  <!-- HubSpot official embed -->
  <script src="https://js.hsforms.net/forms/v2.js"></script>
</head>

<body>
  <h1>Contact</h1>
  <p>Le champ <code>lien_residence</code> sera automatiquement rempli avec l’URL de cette page.</p>

  <!-- HubSpot form container -->
  <div id="hubspot-form"></div>

  <script>
    // Log current page URL immediately
    const currentPageUrl = window.location.href;
    console.log("🌐 Current page URL:", currentPageUrl);

    window.addEventListener("load", function () {
      if (typeof hbspt === "undefined" || !hbspt.forms) {
        console.error("❌ HubSpot library not loaded correctly.");
        return;
      }

      hbspt.forms.create({
        region: "na1",
        portalId: "45176032",
        formId: "4a868650-22f3-4bb5-a389-259d208f3973",
        target: "#hubspot-form",

        onFormReady: function () {
          console.log("✅ HubSpot form loaded.");

          function checkAndFillField() {
            const field = document.querySelector('input[name*="lien_residence"]');

            if (!field) {
              console.warn("⚠️ Field 'lien_residence' not found yet.");
              return false;
            }

            if (field.value === "") {
              field.value = currentPageUrl;
              console.log("✏️ Field found but empty — filled with:", field.value);
              return true;
            } else {
              console.log("✅ Field already filled with:", field.value);
              return true;
            }
          }

          // Retry up to 10 times if not found or still empty
          let attempts = 0;
          const retryInterval = setInterval(() => {
            attempts++;
            console.log(`🔄 Attempt ${attempts} to fill field...`);

            if (checkAndFillField() || attempts >= 10) {
              clearInterval(retryInterval);
              console.log("🟢 Finished checking after", attempts, "attempt(s).");
            }
          }, 500);

          // Final safety: ensure latest value before form submission
          const formElement = document.querySelector("#hubspot-form form");
          if (formElement) {
            formElement.addEventListener("submit", function () {
              checkAndFillField();
            });
          }
        },
      });
    });
  </script>
</body>
</html>
